name: Unit-Tests

on:
  push:
    branches:
      - '*'

jobs:
  unit-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.7

      - name: Pull the Docker image with PLACET
        run: docker pull drozzoff/ubuntu_placet:latest
      
      - name: Start the Docker container
        env:
          COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
        run: docker run -d --name unit_tests drozzoff/ubuntu_placet:latest tail -f /dev/null

      - name: Verify environment variable inside container
        run: docker exec unit_tests bash -c "echo \$COVERALLS_REPO_TOKEN"

      - name: Copy the Placetmachine module to the container
        run: docker cp . unit_tests:module_to_test/

      - name: Create a virtual environment
        run: docker exec unit_tests python3 -m venv /module_to_test/tvenv

      - name: Install Placetmachine, coverage, and coveralls in the container
        run: docker exec unit_tests bash -c "cd /module_to_test && source tvenv/bin/activate && pip3 install /module_to_test/. coverage coveralls"

      - name: Run tests with coverage in container
        run: docker exec unit_tests bash -c "cd /module_to_test && source tvenv/bin/activate && coverage run -m unittest discover -s tests"

      - name: Generate coverage report in container
        run: docker exec unit_tests bash -c "cd /module_to_test && source tvenv/bin/activate && coverage report"

      - name: Generate HTML coverage report in container
        run: docker exec unit_tests bash -c "cd /module_to_test && source tvenv/bin/activate && coverage html"

      - name: Submit coverage to Coveralls from container
        env:
          COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
        run: docker exec -e COVERALLS_REPO_TOKEN=${{ secrets.COVERALLS_REPO_TOKEN }} unit_tests bash -c "cd /module_to_test && source tvenv/bin/activate && coveralls"

      - name: Stop Docker container
        run: docker stop unit_tests

      - name: Remove Docker container
        run: docker rm unit_tests